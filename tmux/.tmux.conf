# ==============================================================================
# CORE SETTINGS
# ==============================================================================

# Eliminate escape delay for vim/neovim responsiveness
set -sg escape-time 0

# Remap prefix from C-b to C-a (more ergonomic)
set -g prefix C-a
unbind C-b
bind C-a send-prefix

# ==============================================================================
# TERMINAL & DISPLAY
# ==============================================================================

# Enable 256 colors and true color (24-bit RGB) support
set -g default-terminal "tmux-256color"
set -as terminal-features ",*:RGB"
set -as terminal-features ",*:usstyle"       # Underline styles (curly, dotted, etc.)
set -as terminal-features ",*:clipboard"     # OSC 52 clipboard support
set -as terminal-features ",*:extkeys"       # Extended keys (CSI u) for modifier detection

# Enable extended keys for proper modifier key support
# Allows distinguishing <C-i> from <Tab>, <C-m> from <Enter>, etc.
set -s extended-keys on

# Allow passthrough for image protocols (kitty graphics, sixel)
set -g allow-passthrough on

# ==============================================================================
# VI MODE
# ==============================================================================

set -g status-keys vi
setw -g mode-keys vi

# ==============================================================================
# COPY MODE
# ==============================================================================

# Search match highlighting
set -g copy-mode-match-style "bg=yellow,fg=black"
set -g copy-mode-current-match-style "bg=brightred,fg=black,bold"

# Enter copy mode with Escape
unbind [
bind Escape copy-mode

# Paste buffer
unbind p
bind p paste-buffer

# Vi-style selection and yanking
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send-keys -X select-line
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle  # Visual block mode
bind -T copy-mode-vi y send -X copy-selection-and-cancel

# Shell prompt navigation (3.4+, requires OSC 133 shell integration)
bind -T copy-mode-vi C-Up send-keys -X previous-prompt
bind -T copy-mode-vi C-Down send-keys -X next-prompt

# System clipboard integration
set -g set-clipboard on

# ==============================================================================
# TIMING & PERFORMANCE
# ==============================================================================

# Repeat time threshold (addresses macOS key repeat issue)
# https://superuser.com/a/1560646/79737
set -g repeat-time 1000

# Message display duration (ms)
set -g display-time 4000

# Pane number display duration (ms)
set -g display-panes-time 1200

# Status bar refresh interval (seconds)
set -g status-interval 5

# ==============================================================================
# STATUS BAR
# ==============================================================================

set-option -g status-position top

# ==============================================================================
# WINDOW & PANE INDEXING
# ==============================================================================

set -g base-index 1                          # Start window numbering at 1
setw -g pane-base-index 1                    # Start pane numbering at 1
set -g renumber-windows on                   # Renumber windows sequentially after closing

# ==============================================================================
# MOUSE & FOCUS
# ==============================================================================

set -g mouse on
set -g focus-events on                       # Pass focus events to applications (required for vim)

# ==============================================================================
# HISTORY & BUFFER
# ==============================================================================

set -g history-limit 50000

# ==============================================================================
# WINDOW BEHAVIOR
# ==============================================================================

setw -g automatic-rename off                 # Preserve manual window names
set -g clock-mode-style 12                   # 12-hour clock format

# ==============================================================================
# ENVIRONMENT VARIABLES
# ==============================================================================

# Propagate environment variables from parent shell (z4m/neovim integration)
set -ga update-environment ' VTE_VERSION KITTY_LISTEN_ON GUAKE_TAB_UUID NVIM NVIM_LISTEN_ADDRESS VIMRUNTIME VIM _Z4M_LINES _Z4M_COLUMNS _Z4M_ORIG_CWD'

# ==============================================================================
# WINDOW SPLITTING
# ==============================================================================

unbind-key '"'
unbind-key '%'

bind | split-window -h -c "#{pane_current_path}"   # Horizontal split
bind \\ split-window -fh -c "#{pane_current_path}" # Full-width horizontal split
bind - split-window -v -c "#{pane_current_path}"   # Vertical split
bind _ split-window -fv -c "#{pane_current_path}"  # Full-height vertical split

# ==============================================================================
# PANE OPERATIONS
# ==============================================================================

# Resize panes (vi-style, -r enables key repeat)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Swap pane positions
bind C-j swap-pane -D
bind C-k swap-pane -U

# ==============================================================================
# UNIFIED NAVIGATION (Neovim + Zsh integration)
# ==============================================================================
# Forward Ctrl+h/j/k/l to applications (neovim, zsh)
# Applications handle navigation internally and call tmux select-pane at edges
# This replaces vim-tmux-navigator with a more integrated approach

bind-key -n C-h send-keys C-h
bind-key -n C-j send-keys C-j
bind-key -n C-k send-keys C-k
bind-key -n C-l send-keys C-l

# Prefix + h/j/k/l for explicit pane navigation (fallback/override)
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# Pane-window conversions
bind b break-pane -d                         # Break pane into new window
bind m choose-window 'join-pane -h -s "%%"'  # Merge window as horizontal pane
bind M choose-window 'join-pane    -s "%%"'  # Merge window as vertical pane

# ==============================================================================
# WINDOW OPERATIONS
# ==============================================================================

# Swap window positions
bind -r < swap-window -d -t -1
bind -r > swap-window -d -t +1

# Quick window selection (no prefix required)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5

# Create new window preserving current path
bind c new-window -c "#{pane_current_path}"

# Toggle to last active window
bind Space last-window

# ==============================================================================
# SESSION OPERATIONS
# ==============================================================================

bind C-Space switch-client -l               # Toggle to last active session
bind C-t choose-tree                        # Interactive session/window tree

# ==============================================================================
# POPUP WINDOWS
# ==============================================================================

bind -n M-g display-popup -T "  lazygit " -w 90% -h 90% -E "lazygit"
bind -n M-t display-popup -T "  btm " -w 80% -h 80% -E "btm"

# ==============================================================================
# MISCELLANEOUS
# ==============================================================================

# Clear screen (preserve scrollback history)
bind C-l send-keys -R

# Reload configuration
bind r source-file ~/.tmux.conf \; display "Configuration reloaded"

# ==============================================================================
# PLUGINS
# ==============================================================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-battery'

set -g @plugin 'sainnhe/tmux-fzf'
TMUX_FZF_OPTIONS="-p -w 60% -h 50% -m"
TMUX_FZF_ORDER="window|pane|session|command|keybinding|clipboard|process"

set -g @plugin 'omerxx/tmux-sessionx'
set -g @sessionx-bind 'f'
set -g @sessionx-window-height '85%'
set -g @sessionx-window-width '75%'
set -g @sessionx-zoxide-mode 'on'

set -g @plugin 'tmux-plugins/tmux-yank'
set -g @yank_action 'copy-pipe'

set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @resurrect-hook-pre-restore-pane-processes 'tmux switch-client -n && tmux kill-session -t 0'
set -g @resurrect-processes 'ssh mosh "~vim->vim" "~nvim->nvim" "~man->man"'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-capture-pane-contents 'on'

# Catppuccin theme (v2)
set -g @plugin 'catppuccin/tmux#v2.1.3'
set -g @catppuccin_flavor "mocha"
set -g @catppuccin_window_status_style "rounded"
set -g @catppuccin_window_text " #W"
set -g @catppuccin_window_current_text " #W"
set -g @catppuccin_window_flags "icon"

set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'

set -g @plugin 'fcsonline/tmux-thumbs'
set -g @thumbs-key j
set -g @thumbs-command 'echo -n {} | pbcopy'
set -g @thumbs-upcase-command 'open {}'

# Status bar layout (after TPM so plugin variables are available)
set -g status-right-length 100
set -g status-left-length 100
set -g status-left ""
set -agF status-right "#{E:@catppuccin_status_battery}"
set -ag status-right "#{E:@catppuccin_status_application}"
set -ag status-right "#{E:@catppuccin_status_session}"
set -ag status-right "#{E:@catppuccin_status_host}"
set -ag status-right "#{E:@catppuccin_status_date_time}"

# Initialize TPM (must be before status-right for plugin variables)
run '~/.tmux/plugins/tpm/tpm'
